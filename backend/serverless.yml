service: project-task-management-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'eu-north-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 256
  timeout: 30
  environment:
    STAGE: ${self:provider.stage}
    TASKS_TABLE: ${self:custom.tasksTable}
    PROJECTS_TABLE: ${self:custom.projectsTable}
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID, self:custom.cognitoUserPoolId}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID, self:custom.cognitoClientId}
    # Note: AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY are reserved by Lambda
    # They are automatically provided by AWS and should not be set as environment variables
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - Fn::GetAtt:
                - TasksTable
                - Arn
            - Fn::GetAtt:
                - ProjectsTable
                - Arn
            - Fn::Join:
                - ''
                - - Fn::GetAtt:
                      - TasksTable
                      - Arn
                  - '/index/*'
            - Fn::Join:
                - ''
                - - Fn::GetAtt:
                      - ProjectsTable
                      - Arn
                  - '/index/*'
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminConfirmSignUp
            - cognito-idp:ListUsers
            - cognito-idp:SignUp
            - cognito-idp:ConfirmSignUp
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
            - cognito-idp:GetUser
          Resource:
            - Fn::GetAtt:
                - CognitoUserPool
                - Arn

custom:
  tasksTable: tasks-${self:provider.stage}
  projectsTable: projects-${self:provider.stage}
  # Cognito IDs - use env vars if provided, otherwise use CloudFormation refs (only works when deployed)
  cognitoUserPoolId:
    Ref: CognitoUserPool
  cognitoClientId:
    Ref: CognitoUserPoolClient
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    useChildProcesses: true
    noPrependStageInUrl: true
    printOutput: true
  
  # OpenAPI/Swagger Documentation
  documentation:
    version: '1.0.0'
    title: 'Project Task Management API'
    description: 'REST API for managing projects and tasks with full CRUD operations. All endpoints except authentication require Cognito JWT token.'
    models:
      # Authentication Models
      - name: SignupInput
        description: 'User signup input'
        contentType: 'application/json'
        schema: ${file(swagger/models/SignupInput.json)}
      - name: SignupResponse
        description: 'User signup response'
        contentType: 'application/json'
        schema: ${file(swagger/models/SignupResponse.json)}
      - name: LoginInput
        description: 'User login input'
        contentType: 'application/json'
        schema: ${file(swagger/models/LoginInput.json)}
      - name: LoginResponse
        description: 'User login response with tokens'
        contentType: 'application/json'
        schema: ${file(swagger/models/LoginResponse.json)}
      - name: ConfirmInput
        description: 'Email confirmation input'
        contentType: 'application/json'
        schema: ${file(swagger/models/ConfirmInput.json)}
      - name: RefreshInput
        description: 'Token refresh input'
        contentType: 'application/json'
        schema: ${file(swagger/models/RefreshInput.json)}
      - name: RefreshResponse
        description: 'Token refresh response'
        contentType: 'application/json'
        schema: ${file(swagger/models/RefreshResponse.json)}
      # Project Models
      - name: Project
        description: 'Project object'
        contentType: 'application/json'
        schema: ${file(swagger/models/Project.json)}
      - name: ProjectInput
        description: 'Project input for creation/update'
        contentType: 'application/json'
        schema: ${file(swagger/models/ProjectInput.json)}
      - name: ProjectList
        description: 'List of projects with pagination'
        contentType: 'application/json'
        schema: ${file(swagger/models/ProjectList.json)}
      # Task Models
      - name: Task
        description: 'Task object'
        contentType: 'application/json'
        schema: ${file(swagger/models/Task.json)}
      - name: TaskInput
        description: 'Task input for creation/update'
        contentType: 'application/json'
        schema: ${file(swagger/models/TaskInput.json)}
      - name: TaskList
        description: 'List of tasks with pagination'
        contentType: 'application/json'
        schema: ${file(swagger/models/TaskList.json)}
      # Error Model
      - name: Error
        description: 'Error response'
        contentType: 'application/json'
        schema: ${file(swagger/models/Error.json)}

plugins:
  - serverless-offline
  # Temporarily disabled to fix deployment - will re-enable after fixing model references
  # - serverless-aws-documentation

functions:
  # ========== AUTHENTICATION ENDPOINTS (Public) ==========
  signup:
    handler: handlers/auth/signup.handler
    events:
      - http:
          path: auth/signup
          method: post
          cors: true
          documentation:
            summary: Sign up a new user
            description: Creates a new user account. User will receive a confirmation code via email.
            requestBody:
              description: User signup data
            requestModels:
              'application/json': SignupInput
            methodResponses:
              - statusCode: 201
                responseBody:
                  description: User registered successfully
                responseModels:
                  'application/json': SignupResponse
              - statusCode: 400
                responseBody:
                  description: Bad request - validation error
                responseModels:
                  'application/json': Error

  login:
    handler: handlers/auth/login.handler
    events:
      - http:
          path: auth/login
          method: post
          cors: true
          documentation:
            summary: Login user
            description: Authenticates a user and returns access tokens
            requestBody:
              description: User login credentials
            requestModels:
              'application/json': LoginInput
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Login successful
                responseModels:
                  'application/json': LoginResponse
              - statusCode: 400
                responseBody:
                  description: Invalid credentials
                responseModels:
                  'application/json': Error

  confirmSignup:
    handler: handlers/auth/confirmSignup.handler
    events:
      - http:
          path: auth/confirm
          method: post
          cors: true
          documentation:
            summary: Confirm user signup
            description: Confirms a user's email address using the confirmation code
            requestBody:
              description: Email and confirmation code
            requestModels:
              'application/json': ConfirmInput
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: User confirmed successfully
              - statusCode: 400
                responseBody:
                  description: Invalid confirmation code
                responseModels:
                  'application/json': Error

  refreshToken:
    handler: handlers/auth/refreshToken.handler
    events:
      - http:
          path: auth/refresh
          method: post
          cors: true
          documentation:
            summary: Refresh access token
            description: Refreshes the access token using a refresh token
            requestBody:
              description: Refresh token
            requestModels:
              'application/json': RefreshInput
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Token refreshed successfully
                responseModels:
                  'application/json': RefreshResponse
              - statusCode: 400
                responseBody:
                  description: Invalid refresh token
                responseModels:
                  'application/json': Error

  # ========== PROJECTS ENDPOINTS (Protected) ==========
  createProject:
    handler: handlers/projects/createProject.handler
    events:
      - http:
          path: projects
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Create a new project
            description: Creates a new project for the authenticated user
            requestBody:
              description: Project data to create
            requestModels:
              'application/json': ProjectInput
            methodResponses:
              - statusCode: 201
                responseBody:
                  description: Project created successfully
                responseModels:
                  'application/json': Project
              - statusCode: 400
                responseBody:
                  description: Bad request - validation error
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error

  getProject:
    handler: handlers/projects/getProject.handler
    events:
      - http:
          path: projects/{projectId}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Get a project by ID
            description: Retrieves a single project by its unique identifier (must belong to authenticated user)
            pathParams:
              - name: id
                description: Project unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Project found
                responseModels:
                  'application/json': Project
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Project not found
                responseModels:
                  'application/json': Error

  listProjects:
    handler: handlers/projects/listProjects.handler
    events:
      - http:
          path: projects
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: List user's projects
            description: Retrieves all projects belonging to the authenticated user
            queryParams:
              - name: limit
                description: Maximum number of items to return (1-1000)
                schema:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  default: 100
              - name: lastEvaluatedKey
                description: Pagination token from previous response (URL encoded JSON)
                schema:
                  type: string
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: List of projects
                responseModels:
                  'application/json': ProjectList
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

  updateProject:
    handler: handlers/projects/updateProject.handler
    events:
      - http:
          path: projects/{projectId}
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Update a project
            description: Updates an existing project (must belong to authenticated user)
            pathParams:
              - name: id
                description: Project unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            requestBody:
              description: Project update data (all fields optional)
            requestModels:
              'application/json': ProjectInput
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Project updated successfully
                responseModels:
                  'application/json': Project
              - statusCode: 400
                responseBody:
                  description: Bad request - validation error
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Project not found
                responseModels:
                  'application/json': Error

  deleteProject:
    handler: handlers/projects/deleteProject.handler
    events:
      - http:
          path: projects/{projectId}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Delete a project
            description: Deletes a project by its unique identifier (must belong to authenticated user)
            pathParams:
              - name: id
                description: Project unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            methodResponses:
              - statusCode: 204
                responseBody:
                  description: Project deleted successfully (no content)
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Project not found
                responseModels:
                  'application/json': Error

  # ========== TASKS ENDPOINTS (Protected) ==========
  createTask:
    handler: handlers/createTask.handler
    events:
      - http:
          path: projects/{projectId}/tasks
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Create a new task
            description: Creates a new task in the specified project (must belong to authenticated user). Returns the created task with generated ID and timestamps.
            pathParams:
              - name: projectId
                description: Project unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            requestBody:
              description: Task data to create
            requestModels:
              'application/json': TaskInput
            methodResponses:
              - statusCode: 201
                responseBody:
                  description: Task created successfully
                responseModels:
                  'application/json': Task
              - statusCode: 400
                responseBody:
                  description: Bad request - validation error
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

  getTask:
    handler: handlers/getTask.handler
    events:
      - http:
          path: tasks/{id}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Get a task by ID
            description: Retrieves a single task by its unique identifier (must belong to authenticated user)
            pathParams:
              - name: id
                description: Task unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Task found
                responseModels:
                  'application/json': Task
              - statusCode: 400
                responseBody:
                  description: Invalid task ID format
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Task not found
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

  listTasks:
    handler: handlers/listTasks.handler
    events:
      - http:
          path: projects/{projectId}/tasks
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: List tasks in a project
            description: Retrieves all tasks belonging to a specific project (must belong to authenticated user) with optional pagination support
            pathParams:
              - name: projectId
                description: Project unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            queryParams:
              - name: limit
                description: Maximum number of items to return (1-1000)
                schema:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  default: 100
              - name: lastEvaluatedKey
                description: Pagination token from previous response (URL encoded JSON)
                schema:
                  type: string
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: List of tasks
                responseModels:
                  'application/json': TaskList
              - statusCode: 400
                responseBody:
                  description: Invalid query parameters
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

  updateTask:
    handler: handlers/updateTask.handler
    events:
      - http:
          path: tasks/{id}
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Update a task
            description: Updates an existing task (must belong to authenticated user). All fields are optional - only provided fields will be updated.
            pathParams:
              - name: id
                description: Task unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            requestBody:
              description: Task update data (all fields optional)
            requestModels:
              'application/json': TaskInput
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: Task updated successfully
                responseModels:
                  'application/json': Task
              - statusCode: 400
                responseBody:
                  description: Bad request - validation error
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Task not found
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

  deleteTask:
    handler: handlers/deleteTask.handler
    events:
      - http:
          path: tasks/{id}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
          documentation:
            summary: Delete a task
            description: Deletes a task by its unique identifier (must belong to authenticated user). Returns 204 No Content on success.
            pathParams:
              - name: id
                description: Task unique identifier (UUID)
                schema:
                  type: string
                  pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            methodResponses:
              - statusCode: 204
                responseBody:
                  description: Task deleted successfully (no content)
              - statusCode: 400
                responseBody:
                  description: Invalid task ID format
                responseModels:
                  'application/json': Error
              - statusCode: 401
                responseBody:
                  description: Unauthorized
                responseModels:
                  'application/json': Error
              - statusCode: 404
                responseBody:
                  description: Task not found
                responseModels:
                  'application/json': Error
              - statusCode: 500
                responseBody:
                  description: Internal server error
                responseModels:
                  'application/json': Error

resources:
  Resources:
    # Cognito User Pool
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${self:provider.stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            Required: true
            Mutable: true
          - Name: name
            Required: true
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: false
            RequireLowercase: false
            RequireNumbers: false
            RequireSymbols: false

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        UserPoolId: { Ref: CognitoUserPool }
        ClientName: ${self:service}-${self:provider.stage}-client
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH

    # Projects Table
    ProjectsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.projectsTable}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: userId-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    # Tasks Table (updated with userId and projectId)
    TasksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tasksTable}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: projectId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: projectId-index
            KeySchema:
              - AttributeName: projectId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: userId-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES

